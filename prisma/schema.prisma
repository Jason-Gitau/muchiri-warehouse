generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id          String   @id @default(uuid())
  email       String   @unique
  fullName    String
  phoneNumber String?
  role        UserRole
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([email])
  @@index([role])
}

enum UserRole {
  OWNER
  MANAGER
  DISTRIBUTOR
  CLIENT
}

model Warehouse {
  id        String   @id @default(uuid())
  name      String
  location  String
  ownerId   String
  createdAt DateTime @default(now())

  @@index([ownerId])
}

model WarehouseManager {
  id          String   @id @default(uuid())
  warehouseId String
  managerId   String
  assignedAt  DateTime @default(now())
  isActive    Boolean  @default(true)

  @@unique([warehouseId, managerId])
  @@index([warehouseId])
  @@index([managerId])
}

model Product {
  id                     String                   @id @default(uuid())
  name                   String
  flavor                 String
  category               String
  sku                    String                   @unique
  unitPrice              Decimal                  @db.Decimal(10, 2)
  imageUrl               String?
  createdAt              DateTime                 @default(now())
  isActive               Boolean                  @default(true)
  warehouseInventory     WarehouseInventory[]
  distributorInventory   DistributorInventory[]
  orderItems             OrderItem[]
  inventoryTransactions  InventoryTransaction[]

  @@index([sku])
  @@index([isActive])
  @@index([category])
}

model WarehouseInventory {
  id              String    @id @default(uuid())
  warehouseId     String
  productId       String
  product         Product   @relation(fields: [productId], references: [id])
  quantity        Int
  reorderLevel    Int       @default(50)
  lastRestockedAt DateTime?
  updatedAt       DateTime  @updatedAt

  @@unique([warehouseId, productId])
  @@index([warehouseId])
  @@index([productId])
}

model DistributorInventory {
  id            String   @id @default(uuid())
  distributorId String
  productId     String
  product       Product  @relation(fields: [productId], references: [id])
  quantity      Int
  updatedAt     DateTime @updatedAt

  @@unique([distributorId, productId])
  @@index([distributorId])
  @@index([productId])
}

model Distributor {
  id           String   @id @default(uuid())
  userId       String   @unique
  businessName String
  phoneNumber  String
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())

  @@index([userId])
  @@index([isActive])
}

model WarehouseDistributor {
  id              String    @id @default(uuid())
  warehouseId     String
  distributorId   String
  addedByManagerId String
  addedAt         DateTime  @default(now())
  removedAt       DateTime?
  isActive        Boolean   @default(true)

  @@unique([warehouseId, distributorId])
  @@index([warehouseId])
  @@index([distributorId])
}

model Client {
  id            String   @id @default(uuid())
  userId        String   @unique
  distributorId String
  businessName  String?
  phoneNumber   String
  location      String
  addedAt       DateTime @default(now())
  isActive      Boolean  @default(true)

  @@index([userId])
  @@index([distributorId])
  @@index([isActive])
}

model Order {
  id                 String        @id @default(uuid())
  orderNumber        String        @unique
  warehouseId        String
  distributorId      String?
  clientId           String?
  placedByUserId     String
  orderType          OrderType
  status             OrderStatus
  totalAmount        Decimal       @db.Decimal(10, 2)
  paymentStatus      PaymentStatus
  paymentMethod      String?
  notes              String?
  createdAt          DateTime      @default(now())
  fulfilledAt        DateTime?
  updatedAt          DateTime      @updatedAt
  orderItem          OrderItem[]

  @@index([orderNumber])
  @@index([warehouseId])
  @@index([distributorId])
  @@index([clientId])
  @@index([status])
  @@index([paymentStatus])
  @@index([createdAt])
}

enum OrderType {
  WAREHOUSE_TO_DISTRIBUTOR
  DISTRIBUTOR_TO_CLIENT
}

enum OrderStatus {
  PENDING
  PROCESSING
  FULFILLED
  CANCELLED
}

enum PaymentStatus {
  UNPAID
  PENDING
  PAID
  FAILED
}

model OrderItem {
  id        String   @id @default(uuid())
  orderId   String
  order     Order    @relation(fields: [orderId], references: [id])
  productId String
  product   Product  @relation(fields: [productId], references: [id])
  quantity  Int
  unitPrice Decimal  @db.Decimal(10, 2)
  subtotal  Decimal  @db.Decimal(10, 2)
  createdAt DateTime @default(now())

  @@index([orderId])
  @@index([productId])
}

model InventoryTransaction {
  id                String          @id @default(uuid())
  warehouseId       String?
  distributorId     String?
  productId         String
  product           Product         @relation(fields: [productId], references: [id])
  transactionType   TransactionType
  quantityChange    Int
  balanceAfter      Int
  referenceOrderId  String?
  performedByUserId String
  notes             String?
  createdAt         DateTime        @default(now())

  @@index([warehouseId])
  @@index([distributorId])
  @@index([productId])
  @@index([transactionType])
  @@index([createdAt])
}

enum TransactionType {
  RESTOCK
  ORDER_FULFILLED
  ORDER_RECEIVED
  ADJUSTMENT
}

model Payment {
  id                  String        @id @default(uuid())
  orderId             String        @unique
  amount              Decimal       @db.Decimal(10, 2)
  paymentMethod       String
  mpesaPhoneNumber    String?
  mpesaTransactionId  String?
  mpesaReceiptNumber  String?
  status              PaymentStatus
  paidAt              DateTime?
  createdAt           DateTime      @default(now())

  @@index([orderId])
  @@index([status])
  @@index([mpesaTransactionId])
}

model ClientPayment {
  id                 String   @id @default(uuid())
  orderId            String
  clientId           String
  distributorId      String
  amount             Decimal  @db.Decimal(10, 2)
  markedPaidByUserId String
  paymentNotes       String?
  markedPaidAt       DateTime @default(now())

  @@index([orderId])
  @@index([clientId])
  @@index([distributorId])
}

model Invitation {
  id            String   @id @default(uuid())
  email         String
  role          UserRole
  token         String   @unique
  createdBy     String
  expiresAt     DateTime
  accepted      Boolean  @default(false)
  acceptedAt    DateTime?
  acceptedByUserId String?
  metadata      Json?    // Stores business name, phone, location, etc
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([email])
  @@index([token])
  @@index([role])
  @@index([accepted])
  @@index([expiresAt])
}
